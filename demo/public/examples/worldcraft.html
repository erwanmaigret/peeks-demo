<html>
    <head>
        <title>Example</title>
        <link rel="stylesheet" href="https://dev.peeks.io/stylesheets/style.css">
    </head>
    <body>
        <header>
        </header>
        <section id="wrapper">
            <script src="/peeks.js"></script>
            <script>
                PEEKS.registerPage('worldcraft', function() {
                    var addVectors = function(v1, v2) {
                        return [v1[0] + v2[0], v1[1] + v2[1], v1[2] + v2[2]];
                    };

                    var move = function() {
                        var scene = this.getScene();
                        var camera = scene.getCamera();
                        var deltaTime = scene.time - scene.timeLast;
                        var speed = 0;
                        if (scene.deviceOrientation !== undefined) {
                            speed = scene.deviceOrientation.beta / 180;
                        }
                        camera.setPosition(addVectors(camera.position, [0, deltaTime * speed, 0]));
                    }

                    var page = new PEEKS.Asset({
                        bgColor: [226/255, 220/255, 209/255],
                        gyroscope: 'on',
                        onUpdate: move,
                    });

                    var assetPath = "/assets/";

                    var animals = [
                        {name: "cat", size: 0.0004},
                        {name: "cow", size: 0.00025},
                        {name: "deer", size: 0.00025},
                        {name: "goat", size: 0.0003},
                        {name: "rat", size: 0.002},
                        {name: "wolf", size: 0.0015}
                    ];

                    var selectedAnimalIndex = 0;

                    var getGeometryUrl = function (part) {
                        return assetPath + "low_poly_animal" + (part !== "" ? "_" + part : "") + ".obj";
                    };

                    var addAnimal = function() {
                        var animal = animals[selectedAnimalIndex];
                        var node = this.addMesh({
                            geometry: getGeometryUrl(animal.name),
                            size: animal.size,
                            color: this.faceColor,
                            autofit: true
                        });
                        return node;
                    };

                    var addWorldCube = function() {
                        var cube = page.addAsset({
                            position: addVectors(this.position, this.offsetCube),
                            faceColor: [Math.random(), Math.random(), Math.random()],
                            faceSize: 0.5,
                            addWorldFace: addWorldFace,
                            addAnimal: addAnimal
                        });
                        cube.addWorldFace(addVectors(cube.position, [cube.faceSize / 2, 0, 0]), [0, 90, 0], [cube.faceSize / 2, 0, 0]);
                        cube.addWorldFace(addVectors(cube.position, [-cube.faceSize / 2, 0, 0]), [0, -90, 0], [-cube.faceSize / 2, 0, 0]);
                        cube.addWorldFace(addVectors(cube.position, [0, cube.faceSize / 2, 0]), [-90, 0, 0], [0, cube.faceSize / 2, 0]);
                        cube.addWorldFace(addVectors(cube.position, [0, -cube.faceSize / 2, 0]), [90, 0, 0], [0, -cube.faceSize / 2, 0]);
                        cube.addWorldFace(addVectors(cube.position, [0, 0, cube.faceSize / 2]), [0, 0, 0], [0, 0, cube.faceSize / 2]);
                        cube.addWorldFace(addVectors(cube.position, [0, 0, -cube.faceSize / 2]), [0, 180, 0], [0, 0, -cube.faceSize / 2]);
                        cube.addAnimal();
                    };

                    var addWorldFace = function(position, rotation, offsetCube) {
                        var view = page.addView({
                            position: position,
                            rotation: rotation,
                            size: this.faceSize,
                            viewBgColor: this.faceColor,
                            offsetCube: offsetCube,
                            onClick: addWorldCube,
                            alpha: 0.1,
                            onFocusStart: function () {
                                this.animate({
                                    duration: .5,
                                    begin: 0,
                                    end: .9,
                                    attribute: 'alpha'
                                });
                            },
                            onFocusEnd: function () {
                                this.animate({
                                    duration: .5,
                                    begin: 0,
                                    end: -.9,
                                    attribute: 'alpha'
                                });
                            }
                        });
                    };

                    var getImageUrl = function (part) {
                        return assetPath + "low_poly_animal" + (part !== "" ? "_" + part : "") + ".jpg";
                    };

                    var canvas = page.addCanvas({
                        valign: "bottom"
                    });

                    var selectedAnimalImage = canvas.addImage({
                        image: assetPath + "material_dark.jpg",
                        position: [selectedAnimalIndex / animals.length + 0.075 - .5, 0.415, 0],
                        size: [0.16, 0.16, 1]
                    });

                    var changeSelectedAnimal = function() {
                        selectedAnimalIndex = this.animalIndex;
                        selectedAnimalImage.setPosition([selectedAnimalIndex / animals.length + 0.075 - .5, 0.415, 0]);
                    };

                    for (var i = 0; i < animals.length; i++) {
                        canvas.addImage({
                            image: getImageUrl(animals[i].name),
                            position: [i / animals.length + 0.075 - .5, 0.415, 0],
                            size: [0.15, 0.15, 1],
                            onClick: changeSelectedAnimal,
                            animalIndex: i
                        });
                    }

                    var initWorld = function() {
                        for (var i = -1; i <= 1; i += 0.5) {
                            for (var j = -3; j <= 1; j += 0.5) {
                                var ground = page.addAsset({
                                    position: [i, -1, j],
                                    offsetCube: [0, 0.25, 0],
                                    createCube: addWorldCube
                                });
                                selectedAnimalIndex = Math.floor(Math.random() * animals.length);
                                ground.createCube();
                            }
                        }
                        selectedAnimalImage.setPosition([selectedAnimalIndex / animals.length + 0.075 - .5, 0.415, 0]);
                    }

                    initWorld();

                    return page;
                });

                PEEKS.start(window, 'worldcraft');
            </script>
        </section>
    </body>
</html>
